name: CI

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number }}
  cancel-in-progress: true

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  Lint:
    uses: ./.github/workflows/call-lint.yml
    secrets:
      API_KEY: ${{ secrets.API_KEY }}

  unit_tests:
    uses: ./.github/workflows/call-unit-test.yml
    secrets:
      API_KEY: ${{ secrets.API_KEY }}

  auto-merge:
    needs: [ Lint, unit_tests ]
    if: ${{ github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'reopened') }}
    uses: ./.github/workflows/auto-merge.yml
    permissions:
      checks: write
      pull-requests: write

    secrets:
      CI_TOKEN: ${{ secrets.CI_TOKEN }}
